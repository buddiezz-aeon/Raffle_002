{"ast":null,"code":"import * as anchor from '@project-serum/anchor';\nimport { MintLayout, TOKEN_PROGRAM_ID, Token } from '@solana/spl-token';\nimport { SystemProgram, SYSVAR_SLOT_HASHES_PUBKEY } from '@solana/web3.js';\nimport { sendTransactions, SequenceType } from './connection';\nimport { CIVIC, getAtaForMint, getNetworkExpire, getNetworkToken, SPL_ASSOCIATED_TOKEN_ACCOUNT_PROGRAM_ID } from './utils';\nexport const CANDY_MACHINE_PROGRAM = new anchor.web3.PublicKey('cndy3Z4yapfJBmL3ShUp5exZKqR3z33thTzeNMm2gRZ');\nconst TOKEN_METADATA_PROGRAM_ID = new anchor.web3.PublicKey('metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s');\nexport const awaitTransactionSignatureConfirmation = async function (txid, timeout, connection) {\n  let queryStatus = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;\n  let done = false;\n  let status = {\n    slot: 0,\n    confirmations: 0,\n    err: null\n  };\n  let subId = 0;\n  status = await new Promise(async (resolve, reject) => {\n    setTimeout(() => {\n      if (done) {\n        return;\n      }\n\n      done = true;\n      console.log('Rejecting for timeout...');\n      reject({\n        timeout: true\n      });\n    }, timeout);\n\n    while (!done && queryStatus) {\n      // eslint-disable-next-line no-loop-func\n      (async () => {\n        try {\n          const signatureStatuses = await connection.getSignatureStatuses([txid]);\n          status = signatureStatuses && signatureStatuses.value[0];\n\n          if (!done) {\n            if (!status) {\n              console.log('REST null result for', txid, status);\n            } else if (status.err) {\n              console.log('REST error for', txid, status);\n              done = true;\n              reject(status.err);\n            } else if (!status.confirmations) {\n              console.log('REST no confirmations for', txid, status);\n            } else {\n              console.log('REST confirmation for', txid, status);\n              done = true;\n              resolve(status);\n            }\n          }\n        } catch (e) {\n          if (!done) {\n            console.log('REST connection error: txid', txid, e);\n          }\n        }\n      })();\n\n      await sleep(2000);\n    }\n  }); //@ts-ignore\n\n  if (connection._signatureSubscriptions[subId]) {\n    connection.removeSignatureListener(subId);\n  }\n\n  done = true;\n  console.log('Returning status', status);\n  return status;\n};\n\nconst createAssociatedTokenAccountInstruction = (associatedTokenAddress, payer, walletAddress, splTokenMintAddress) => {\n  const keys = [{\n    pubkey: payer,\n    isSigner: true,\n    isWritable: true\n  }, {\n    pubkey: associatedTokenAddress,\n    isSigner: false,\n    isWritable: true\n  }, {\n    pubkey: walletAddress,\n    isSigner: false,\n    isWritable: false\n  }, {\n    pubkey: splTokenMintAddress,\n    isSigner: false,\n    isWritable: false\n  }, {\n    pubkey: anchor.web3.SystemProgram.programId,\n    isSigner: false,\n    isWritable: false\n  }, {\n    pubkey: TOKEN_PROGRAM_ID,\n    isSigner: false,\n    isWritable: false\n  }, {\n    pubkey: anchor.web3.SYSVAR_RENT_PUBKEY,\n    isSigner: false,\n    isWritable: false\n  }];\n  return new anchor.web3.TransactionInstruction({\n    keys,\n    programId: SPL_ASSOCIATED_TOKEN_ACCOUNT_PROGRAM_ID,\n    data: Buffer.from([])\n  });\n};\n\nexport const getCandyMachineState = async (anchorWallet, candyMachineId, connection) => {\n  const provider = new anchor.Provider(connection, anchorWallet, {\n    preflightCommitment: 'processed'\n  });\n  const idl = await anchor.Program.fetchIdl(CANDY_MACHINE_PROGRAM, provider);\n  const program = new anchor.Program(idl, CANDY_MACHINE_PROGRAM, provider);\n  const state = await program.account.candyMachine.fetch(candyMachineId);\n  const itemsAvailable = state.data.itemsAvailable.toNumber();\n  const itemsRedeemed = state.itemsRedeemed.toNumber();\n  const itemsRemaining = itemsAvailable - itemsRedeemed;\n  const presale = state.data.whitelistMintSettings && state.data.whitelistMintSettings.presale && (!state.data.goLiveDate || state.data.goLiveDate.toNumber() > new Date().getTime() / 1000);\n  return {\n    id: candyMachineId,\n    program,\n    state: {\n      authority: state.authority,\n      itemsAvailable,\n      itemsRedeemed,\n      itemsRemaining,\n      isSoldOut: itemsRemaining === 0,\n      isActive: false,\n      isPresale: false,\n      isWhitelistOnly: false,\n      goLiveDate: state.data.goLiveDate,\n      treasury: state.wallet,\n      tokenMint: state.tokenMint,\n      gatekeeper: state.data.gatekeeper,\n      endSettings: state.data.endSettings,\n      whitelistMintSettings: state.data.whitelistMintSettings,\n      hiddenSettings: state.data.hiddenSettings,\n      price: state.data.price,\n      retainAuthority: state.data.retainAuthority\n    }\n  };\n};\n\nconst getMasterEdition = async mint => {\n  return (await anchor.web3.PublicKey.findProgramAddress([Buffer.from('metadata'), TOKEN_METADATA_PROGRAM_ID.toBuffer(), mint.toBuffer(), Buffer.from('edition')], TOKEN_METADATA_PROGRAM_ID))[0];\n};\n\nconst getMetadata = async mint => {\n  return (await anchor.web3.PublicKey.findProgramAddress([Buffer.from('metadata'), TOKEN_METADATA_PROGRAM_ID.toBuffer(), mint.toBuffer()], TOKEN_METADATA_PROGRAM_ID))[0];\n};\n\nexport const getCandyMachineCreator = async candyMachine => {\n  return await anchor.web3.PublicKey.findProgramAddress([Buffer.from('candy_machine'), candyMachine.toBuffer()], CANDY_MACHINE_PROGRAM);\n};\nexport const getCollectionPDA = async candyMachineAddress => {\n  return await anchor.web3.PublicKey.findProgramAddress([Buffer.from('collection'), candyMachineAddress.toBuffer()], CANDY_MACHINE_PROGRAM);\n};\nexport const getCollectionAuthorityRecordPDA = async (mint, newAuthority) => {\n  return (await anchor.web3.PublicKey.findProgramAddress([Buffer.from('metadata'), TOKEN_METADATA_PROGRAM_ID.toBuffer(), mint.toBuffer(), Buffer.from('collection_authority'), newAuthority.toBuffer()], TOKEN_METADATA_PROGRAM_ID))[0];\n};\nexport const createAccountsForMint = async (candyMachine, payer) => {\n  const mint = anchor.web3.Keypair.generate();\n  const userTokenAccountAddress = (await getAtaForMint(mint.publicKey, payer))[0];\n  const signers = [mint];\n  const instructions = [anchor.web3.SystemProgram.createAccount({\n    fromPubkey: payer,\n    newAccountPubkey: mint.publicKey,\n    space: MintLayout.span,\n    lamports: await candyMachine.program.provider.connection.getMinimumBalanceForRentExemption(MintLayout.span),\n    programId: TOKEN_PROGRAM_ID\n  }), Token.createInitMintInstruction(TOKEN_PROGRAM_ID, mint.publicKey, 0, payer, payer), createAssociatedTokenAccountInstruction(userTokenAccountAddress, payer, payer, mint.publicKey), Token.createMintToInstruction(TOKEN_PROGRAM_ID, mint.publicKey, userTokenAccountAddress, payer, [], 1)];\n  return {\n    mint: mint,\n    userTokenAccount: userTokenAccountAddress,\n    transaction: (await sendTransactions(candyMachine.program.provider.connection, candyMachine.program.provider.wallet, [instructions], [signers], SequenceType.StopOnFailure, 'singleGossip', () => {}, () => false, undefined, [], [])).txs[0].txid\n  };\n};\nexport const mintOneToken = async function (candyMachine, payer) {\n  var _setupState$mint;\n\n  let beforeTransactions = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n  let afterTransactions = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : [];\n  let setupState = arguments.length > 4 ? arguments[4] : undefined;\n  const mint = (_setupState$mint = setupState === null || setupState === void 0 ? void 0 : setupState.mint) !== null && _setupState$mint !== void 0 ? _setupState$mint : anchor.web3.Keypair.generate();\n  const userTokenAccountAddress = (await getAtaForMint(mint.publicKey, payer))[0];\n  const userPayingAccountAddress = candyMachine.state.tokenMint ? (await getAtaForMint(candyMachine.state.tokenMint, payer))[0] : payer;\n  const candyMachineAddress = candyMachine.id;\n  const remainingAccounts = [];\n  const cleanupInstructions = [];\n  const instructions = [];\n  const signers = [];\n  console.log('SetupState: ', setupState);\n\n  if (!setupState) {\n    signers.push(mint);\n    instructions.push(...[anchor.web3.SystemProgram.createAccount({\n      fromPubkey: payer,\n      newAccountPubkey: mint.publicKey,\n      space: MintLayout.span,\n      lamports: await candyMachine.program.provider.connection.getMinimumBalanceForRentExemption(MintLayout.span),\n      programId: TOKEN_PROGRAM_ID\n    }), Token.createInitMintInstruction(TOKEN_PROGRAM_ID, mint.publicKey, 0, payer, payer), createAssociatedTokenAccountInstruction(userTokenAccountAddress, payer, payer, mint.publicKey), Token.createMintToInstruction(TOKEN_PROGRAM_ID, mint.publicKey, userTokenAccountAddress, payer, [], 1)]);\n  }\n\n  if (candyMachine.state.gatekeeper) {\n    remainingAccounts.push({\n      pubkey: (await getNetworkToken(payer, candyMachine.state.gatekeeper.gatekeeperNetwork))[0],\n      isWritable: true,\n      isSigner: false\n    });\n\n    if (candyMachine.state.gatekeeper.expireOnUse) {\n      remainingAccounts.push({\n        pubkey: CIVIC,\n        isWritable: false,\n        isSigner: false\n      });\n      remainingAccounts.push({\n        pubkey: (await getNetworkExpire(candyMachine.state.gatekeeper.gatekeeperNetwork))[0],\n        isWritable: false,\n        isSigner: false\n      });\n    }\n  }\n\n  if (candyMachine.state.whitelistMintSettings) {\n    const mint = new anchor.web3.PublicKey(candyMachine.state.whitelistMintSettings.mint);\n    const whitelistToken = (await getAtaForMint(mint, payer))[0];\n    remainingAccounts.push({\n      pubkey: whitelistToken,\n      isWritable: true,\n      isSigner: false\n    });\n\n    if (candyMachine.state.whitelistMintSettings.mode.burnEveryTime) {\n      const whitelistBurnAuthority = anchor.web3.Keypair.generate();\n      remainingAccounts.push({\n        pubkey: mint,\n        isWritable: true,\n        isSigner: false\n      });\n      remainingAccounts.push({\n        pubkey: whitelistBurnAuthority.publicKey,\n        isWritable: false,\n        isSigner: true\n      });\n      signers.push(whitelistBurnAuthority);\n      const exists = await candyMachine.program.provider.connection.getAccountInfo(whitelistToken);\n\n      if (exists) {\n        instructions.push(Token.createApproveInstruction(TOKEN_PROGRAM_ID, whitelistToken, whitelistBurnAuthority.publicKey, payer, [], 1));\n        cleanupInstructions.push(Token.createRevokeInstruction(TOKEN_PROGRAM_ID, whitelistToken, payer, []));\n      }\n    }\n  }\n\n  if (candyMachine.state.tokenMint) {\n    const transferAuthority = anchor.web3.Keypair.generate();\n    signers.push(transferAuthority);\n    remainingAccounts.push({\n      pubkey: userPayingAccountAddress,\n      isWritable: true,\n      isSigner: false\n    });\n    remainingAccounts.push({\n      pubkey: transferAuthority.publicKey,\n      isWritable: false,\n      isSigner: true\n    });\n    instructions.push(Token.createApproveInstruction(TOKEN_PROGRAM_ID, userPayingAccountAddress, transferAuthority.publicKey, payer, [], candyMachine.state.price.toNumber()));\n    cleanupInstructions.push(Token.createRevokeInstruction(TOKEN_PROGRAM_ID, userPayingAccountAddress, payer, []));\n  }\n\n  const metadataAddress = await getMetadata(mint.publicKey);\n  const masterEdition = await getMasterEdition(mint.publicKey);\n  const [candyMachineCreator, creatorBump] = await getCandyMachineCreator(candyMachineAddress);\n  console.log(remainingAccounts.map(rm => rm.pubkey.toBase58()));\n  instructions.push(await candyMachine.program.instruction.mintNft(creatorBump, {\n    accounts: {\n      candyMachine: candyMachineAddress,\n      candyMachineCreator,\n      payer: payer,\n      wallet: candyMachine.state.treasury,\n      mint: mint.publicKey,\n      metadata: metadataAddress,\n      masterEdition,\n      mintAuthority: payer,\n      updateAuthority: payer,\n      tokenMetadataProgram: TOKEN_METADATA_PROGRAM_ID,\n      tokenProgram: TOKEN_PROGRAM_ID,\n      systemProgram: SystemProgram.programId,\n      rent: anchor.web3.SYSVAR_RENT_PUBKEY,\n      clock: anchor.web3.SYSVAR_CLOCK_PUBKEY,\n      recentBlockhashes: SYSVAR_SLOT_HASHES_PUBKEY,\n      instructionSysvarAccount: anchor.web3.SYSVAR_INSTRUCTIONS_PUBKEY\n    },\n    remainingAccounts: remainingAccounts.length > 0 ? remainingAccounts : undefined\n  }));\n  const [collectionPDA] = await getCollectionPDA(candyMachineAddress);\n  const collectionPDAAccount = await candyMachine.program.provider.connection.getAccountInfo(collectionPDA);\n\n  if (collectionPDAAccount && candyMachine.state.retainAuthority) {\n    try {\n      const collectionData = await candyMachine.program.account.collectionPda.fetch(collectionPDA);\n      console.log(collectionData);\n      const collectionMint = collectionData.mint;\n      const collectionAuthorityRecord = await getCollectionAuthorityRecordPDA(collectionMint, collectionPDA);\n      console.log(collectionMint);\n\n      if (collectionMint) {\n        const collectionMetadata = await getMetadata(collectionMint);\n        const collectionMasterEdition = await getMasterEdition(collectionMint);\n        console.log('Collection PDA: ', collectionPDA.toBase58());\n        console.log('Authority: ', candyMachine.state.authority.toBase58());\n        instructions.push(await candyMachine.program.instruction.setCollectionDuringMint({\n          accounts: {\n            candyMachine: candyMachineAddress,\n            metadata: metadataAddress,\n            payer: payer,\n            collectionPda: collectionPDA,\n            tokenMetadataProgram: TOKEN_METADATA_PROGRAM_ID,\n            instructions: anchor.web3.SYSVAR_INSTRUCTIONS_PUBKEY,\n            collectionMint,\n            collectionMetadata,\n            collectionMasterEdition,\n            authority: candyMachine.state.authority,\n            collectionAuthorityRecord\n          }\n        }));\n      }\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n  const instructionsMatrix = [instructions, cleanupInstructions];\n  const signersMatrix = [signers, []];\n\n  try {\n    const txns = (await sendTransactions(candyMachine.program.provider.connection, candyMachine.program.provider.wallet, instructionsMatrix, signersMatrix, SequenceType.StopOnFailure, 'singleGossip', () => {}, () => false, undefined, beforeTransactions, afterTransactions)).txs.map(t => t.txid);\n    const mintTxn = txns[0];\n    return {\n      mintTxId: mintTxn,\n      metadataKey: metadataAddress\n    };\n  } catch (e) {\n    console.log(e);\n  }\n\n  return null;\n};\nexport const shortenAddress = function (address) {\n  let chars = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 4;\n  return `${address.slice(0, chars)}...${address.slice(-chars)}`;\n};\n\nconst sleep = ms => {\n  return new Promise(resolve => setTimeout(resolve, ms));\n};","map":{"version":3,"sources":["C:/Users/class/Buddiezz/metaplex/js/packages/candy-machine-ui/src/candy-machine.ts"],"names":["anchor","MintLayout","TOKEN_PROGRAM_ID","Token","SystemProgram","SYSVAR_SLOT_HASHES_PUBKEY","sendTransactions","SequenceType","CIVIC","getAtaForMint","getNetworkExpire","getNetworkToken","SPL_ASSOCIATED_TOKEN_ACCOUNT_PROGRAM_ID","CANDY_MACHINE_PROGRAM","web3","PublicKey","TOKEN_METADATA_PROGRAM_ID","awaitTransactionSignatureConfirmation","txid","timeout","connection","queryStatus","done","status","slot","confirmations","err","subId","Promise","resolve","reject","setTimeout","console","log","signatureStatuses","getSignatureStatuses","value","e","sleep","_signatureSubscriptions","removeSignatureListener","createAssociatedTokenAccountInstruction","associatedTokenAddress","payer","walletAddress","splTokenMintAddress","keys","pubkey","isSigner","isWritable","programId","SYSVAR_RENT_PUBKEY","TransactionInstruction","data","Buffer","from","getCandyMachineState","anchorWallet","candyMachineId","provider","Provider","preflightCommitment","idl","Program","fetchIdl","program","state","account","candyMachine","fetch","itemsAvailable","toNumber","itemsRedeemed","itemsRemaining","presale","whitelistMintSettings","goLiveDate","Date","getTime","id","authority","isSoldOut","isActive","isPresale","isWhitelistOnly","treasury","wallet","tokenMint","gatekeeper","endSettings","hiddenSettings","price","retainAuthority","getMasterEdition","mint","findProgramAddress","toBuffer","getMetadata","getCandyMachineCreator","getCollectionPDA","candyMachineAddress","getCollectionAuthorityRecordPDA","newAuthority","createAccountsForMint","Keypair","generate","userTokenAccountAddress","publicKey","signers","instructions","createAccount","fromPubkey","newAccountPubkey","space","span","lamports","getMinimumBalanceForRentExemption","createInitMintInstruction","createMintToInstruction","userTokenAccount","transaction","StopOnFailure","undefined","txs","mintOneToken","beforeTransactions","afterTransactions","setupState","userPayingAccountAddress","remainingAccounts","cleanupInstructions","push","gatekeeperNetwork","expireOnUse","whitelistToken","mode","burnEveryTime","whitelistBurnAuthority","exists","getAccountInfo","createApproveInstruction","createRevokeInstruction","transferAuthority","metadataAddress","masterEdition","candyMachineCreator","creatorBump","map","rm","toBase58","instruction","mintNft","accounts","metadata","mintAuthority","updateAuthority","tokenMetadataProgram","tokenProgram","systemProgram","rent","clock","SYSVAR_CLOCK_PUBKEY","recentBlockhashes","instructionSysvarAccount","SYSVAR_INSTRUCTIONS_PUBKEY","length","collectionPDA","collectionPDAAccount","collectionData","collectionPda","collectionMint","collectionAuthorityRecord","collectionMetadata","collectionMasterEdition","setCollectionDuringMint","error","instructionsMatrix","signersMatrix","txns","t","mintTxn","mintTxId","metadataKey","shortenAddress","address","chars","slice","ms"],"mappings":"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","sourcesContent":["import * as anchor from '@project-serum/anchor';\r\n\r\nimport { MintLayout, TOKEN_PROGRAM_ID, Token } from '@solana/spl-token';\r\nimport {\r\n  SystemProgram,\r\n  Transaction,\r\n  SYSVAR_SLOT_HASHES_PUBKEY,\r\n} from '@solana/web3.js';\r\nimport { sendTransactions, SequenceType } from './connection';\r\n\r\nimport {\r\n  CIVIC,\r\n  getAtaForMint,\r\n  getNetworkExpire,\r\n  getNetworkToken,\r\n  SPL_ASSOCIATED_TOKEN_ACCOUNT_PROGRAM_ID,\r\n} from './utils';\r\n\r\nexport const CANDY_MACHINE_PROGRAM = new anchor.web3.PublicKey(\r\n  'cndy3Z4yapfJBmL3ShUp5exZKqR3z33thTzeNMm2gRZ',\r\n);\r\n\r\nconst TOKEN_METADATA_PROGRAM_ID = new anchor.web3.PublicKey(\r\n  'metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s',\r\n);\r\n\r\ninterface CandyMachineState {\r\n  authority: anchor.web3.PublicKey;\r\n  itemsAvailable: number;\r\n  itemsRedeemed: number;\r\n  itemsRemaining: number;\r\n  treasury: anchor.web3.PublicKey;\r\n  tokenMint: null | anchor.web3.PublicKey;\r\n  isSoldOut: boolean;\r\n  isActive: boolean;\r\n  isPresale: boolean;\r\n  isWhitelistOnly: boolean;\r\n  goLiveDate: anchor.BN;\r\n  price: anchor.BN;\r\n  gatekeeper: null | {\r\n    expireOnUse: boolean;\r\n    gatekeeperNetwork: anchor.web3.PublicKey;\r\n  };\r\n  endSettings: null | {\r\n    number: anchor.BN;\r\n    endSettingType: any;\r\n  };\r\n  whitelistMintSettings: null | {\r\n    mode: any;\r\n    mint: anchor.web3.PublicKey;\r\n    presale: boolean;\r\n    discountPrice: null | anchor.BN;\r\n  };\r\n  hiddenSettings: null | {\r\n    name: string;\r\n    uri: string;\r\n    hash: Uint8Array;\r\n  };\r\n  retainAuthority: boolean;\r\n}\r\n\r\nexport interface CandyMachineAccount {\r\n  id: anchor.web3.PublicKey;\r\n  program: anchor.Program;\r\n  state: CandyMachineState;\r\n}\r\n\r\nexport const awaitTransactionSignatureConfirmation = async (\r\n  txid: anchor.web3.TransactionSignature,\r\n  timeout: number,\r\n  connection: anchor.web3.Connection,\r\n  queryStatus = false,\r\n): Promise<anchor.web3.SignatureStatus | null | void> => {\r\n  let done = false;\r\n  let status: anchor.web3.SignatureStatus | null | void = {\r\n    slot: 0,\r\n    confirmations: 0,\r\n    err: null,\r\n  };\r\n  let subId = 0;\r\n  status = await new Promise(async (resolve, reject) => {\r\n    setTimeout(() => {\r\n      if (done) {\r\n        return;\r\n      }\r\n      done = true;\r\n      console.log('Rejecting for timeout...');\r\n      reject({ timeout: true });\r\n    }, timeout);\r\n\r\n    while (!done && queryStatus) {\r\n      // eslint-disable-next-line no-loop-func\r\n      (async () => {\r\n        try {\r\n          const signatureStatuses = await connection.getSignatureStatuses([\r\n            txid,\r\n          ]);\r\n          status = signatureStatuses && signatureStatuses.value[0];\r\n          if (!done) {\r\n            if (!status) {\r\n              console.log('REST null result for', txid, status);\r\n            } else if (status.err) {\r\n              console.log('REST error for', txid, status);\r\n              done = true;\r\n              reject(status.err);\r\n            } else if (!status.confirmations) {\r\n              console.log('REST no confirmations for', txid, status);\r\n            } else {\r\n              console.log('REST confirmation for', txid, status);\r\n              done = true;\r\n              resolve(status);\r\n            }\r\n          }\r\n        } catch (e) {\r\n          if (!done) {\r\n            console.log('REST connection error: txid', txid, e);\r\n          }\r\n        }\r\n      })();\r\n      await sleep(2000);\r\n    }\r\n  });\r\n\r\n  //@ts-ignore\r\n  if (connection._signatureSubscriptions[subId]) {\r\n    connection.removeSignatureListener(subId);\r\n  }\r\n  done = true;\r\n  console.log('Returning status', status);\r\n  return status;\r\n};\r\n\r\nconst createAssociatedTokenAccountInstruction = (\r\n  associatedTokenAddress: anchor.web3.PublicKey,\r\n  payer: anchor.web3.PublicKey,\r\n  walletAddress: anchor.web3.PublicKey,\r\n  splTokenMintAddress: anchor.web3.PublicKey,\r\n) => {\r\n  const keys = [\r\n    { pubkey: payer, isSigner: true, isWritable: true },\r\n    { pubkey: associatedTokenAddress, isSigner: false, isWritable: true },\r\n    { pubkey: walletAddress, isSigner: false, isWritable: false },\r\n    { pubkey: splTokenMintAddress, isSigner: false, isWritable: false },\r\n    {\r\n      pubkey: anchor.web3.SystemProgram.programId,\r\n      isSigner: false,\r\n      isWritable: false,\r\n    },\r\n    { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },\r\n    {\r\n      pubkey: anchor.web3.SYSVAR_RENT_PUBKEY,\r\n      isSigner: false,\r\n      isWritable: false,\r\n    },\r\n  ];\r\n  return new anchor.web3.TransactionInstruction({\r\n    keys,\r\n    programId: SPL_ASSOCIATED_TOKEN_ACCOUNT_PROGRAM_ID,\r\n    data: Buffer.from([]),\r\n  });\r\n};\r\n\r\nexport const getCandyMachineState = async (\r\n  anchorWallet: anchor.Wallet,\r\n  candyMachineId: anchor.web3.PublicKey,\r\n  connection: anchor.web3.Connection,\r\n): Promise<CandyMachineAccount> => {\r\n  const provider = new anchor.Provider(connection, anchorWallet, {\r\n    preflightCommitment: 'processed',\r\n  });\r\n\r\n  const idl = await anchor.Program.fetchIdl(CANDY_MACHINE_PROGRAM, provider);\r\n\r\n  const program = new anchor.Program(idl!, CANDY_MACHINE_PROGRAM, provider);\r\n\r\n  const state: any = await program.account.candyMachine.fetch(candyMachineId);\r\n  const itemsAvailable = state.data.itemsAvailable.toNumber();\r\n  const itemsRedeemed = state.itemsRedeemed.toNumber();\r\n  const itemsRemaining = itemsAvailable - itemsRedeemed;\r\n\r\n  const presale =\r\n    state.data.whitelistMintSettings &&\r\n    state.data.whitelistMintSettings.presale &&\r\n    (!state.data.goLiveDate ||\r\n      state.data.goLiveDate.toNumber() > new Date().getTime() / 1000);\r\n\r\n  return {\r\n    id: candyMachineId,\r\n    program,\r\n    state: {\r\n      authority: state.authority,\r\n      itemsAvailable,\r\n      itemsRedeemed,\r\n      itemsRemaining,\r\n      isSoldOut: itemsRemaining === 0,\r\n      isActive: false,\r\n      isPresale: false,\r\n      isWhitelistOnly: false,\r\n      goLiveDate: state.data.goLiveDate,\r\n      treasury: state.wallet,\r\n      tokenMint: state.tokenMint,\r\n      gatekeeper: state.data.gatekeeper,\r\n      endSettings: state.data.endSettings,\r\n      whitelistMintSettings: state.data.whitelistMintSettings,\r\n      hiddenSettings: state.data.hiddenSettings,\r\n      price: state.data.price,\r\n      retainAuthority: state.data.retainAuthority,\r\n    },\r\n  };\r\n};\r\n\r\nconst getMasterEdition = async (\r\n  mint: anchor.web3.PublicKey,\r\n): Promise<anchor.web3.PublicKey> => {\r\n  return (\r\n    await anchor.web3.PublicKey.findProgramAddress(\r\n      [\r\n        Buffer.from('metadata'),\r\n        TOKEN_METADATA_PROGRAM_ID.toBuffer(),\r\n        mint.toBuffer(),\r\n        Buffer.from('edition'),\r\n      ],\r\n      TOKEN_METADATA_PROGRAM_ID,\r\n    )\r\n  )[0];\r\n};\r\n\r\nconst getMetadata = async (\r\n  mint: anchor.web3.PublicKey,\r\n): Promise<anchor.web3.PublicKey> => {\r\n  return (\r\n    await anchor.web3.PublicKey.findProgramAddress(\r\n      [\r\n        Buffer.from('metadata'),\r\n        TOKEN_METADATA_PROGRAM_ID.toBuffer(),\r\n        mint.toBuffer(),\r\n      ],\r\n      TOKEN_METADATA_PROGRAM_ID,\r\n    )\r\n  )[0];\r\n};\r\n\r\nexport const getCandyMachineCreator = async (\r\n  candyMachine: anchor.web3.PublicKey,\r\n): Promise<[anchor.web3.PublicKey, number]> => {\r\n  return await anchor.web3.PublicKey.findProgramAddress(\r\n    [Buffer.from('candy_machine'), candyMachine.toBuffer()],\r\n    CANDY_MACHINE_PROGRAM,\r\n  );\r\n};\r\n\r\nexport const getCollectionPDA = async (\r\n  candyMachineAddress: anchor.web3.PublicKey,\r\n): Promise<[anchor.web3.PublicKey, number]> => {\r\n  return await anchor.web3.PublicKey.findProgramAddress(\r\n    [Buffer.from('collection'), candyMachineAddress.toBuffer()],\r\n    CANDY_MACHINE_PROGRAM,\r\n  );\r\n};\r\n\r\nexport interface CollectionData {\r\n  mint: anchor.web3.PublicKey;\r\n  candyMachine: anchor.web3.PublicKey;\r\n}\r\n\r\nexport const getCollectionAuthorityRecordPDA = async (\r\n  mint: anchor.web3.PublicKey,\r\n  newAuthority: anchor.web3.PublicKey,\r\n): Promise<anchor.web3.PublicKey> => {\r\n  return (\r\n    await anchor.web3.PublicKey.findProgramAddress(\r\n      [\r\n        Buffer.from('metadata'),\r\n        TOKEN_METADATA_PROGRAM_ID.toBuffer(),\r\n        mint.toBuffer(),\r\n        Buffer.from('collection_authority'),\r\n        newAuthority.toBuffer(),\r\n      ],\r\n      TOKEN_METADATA_PROGRAM_ID,\r\n    )\r\n  )[0];\r\n};\r\n\r\nexport type SetupState = {\r\n  mint: anchor.web3.Keypair;\r\n  userTokenAccount: anchor.web3.PublicKey;\r\n  transaction: string;\r\n};\r\n\r\nexport const createAccountsForMint = async (\r\n  candyMachine: CandyMachineAccount,\r\n  payer: anchor.web3.PublicKey,\r\n): Promise<SetupState> => {\r\n  const mint = anchor.web3.Keypair.generate();\r\n  const userTokenAccountAddress = (\r\n    await getAtaForMint(mint.publicKey, payer)\r\n  )[0];\r\n\r\n  const signers: anchor.web3.Keypair[] = [mint];\r\n  const instructions = [\r\n    anchor.web3.SystemProgram.createAccount({\r\n      fromPubkey: payer,\r\n      newAccountPubkey: mint.publicKey,\r\n      space: MintLayout.span,\r\n      lamports:\r\n        await candyMachine.program.provider.connection.getMinimumBalanceForRentExemption(\r\n          MintLayout.span,\r\n        ),\r\n      programId: TOKEN_PROGRAM_ID,\r\n    }),\r\n    Token.createInitMintInstruction(\r\n      TOKEN_PROGRAM_ID,\r\n      mint.publicKey,\r\n      0,\r\n      payer,\r\n      payer,\r\n    ),\r\n    createAssociatedTokenAccountInstruction(\r\n      userTokenAccountAddress,\r\n      payer,\r\n      payer,\r\n      mint.publicKey,\r\n    ),\r\n    Token.createMintToInstruction(\r\n      TOKEN_PROGRAM_ID,\r\n      mint.publicKey,\r\n      userTokenAccountAddress,\r\n      payer,\r\n      [],\r\n      1,\r\n    ),\r\n  ];\r\n\r\n  return {\r\n    mint: mint,\r\n    userTokenAccount: userTokenAccountAddress,\r\n    transaction: (\r\n      await sendTransactions(\r\n        candyMachine.program.provider.connection,\r\n        candyMachine.program.provider.wallet,\r\n        [instructions],\r\n        [signers],\r\n        SequenceType.StopOnFailure,\r\n        'singleGossip',\r\n        () => {},\r\n        () => false,\r\n        undefined,\r\n        [],\r\n        [],\r\n      )\r\n    ).txs[0].txid,\r\n  };\r\n};\r\n\r\ntype MintResult = {\r\n  mintTxId: string;\r\n  metadataKey: anchor.web3.PublicKey;\r\n};\r\n\r\nexport const mintOneToken = async (\r\n  candyMachine: CandyMachineAccount,\r\n  payer: anchor.web3.PublicKey,\r\n  beforeTransactions: Transaction[] = [],\r\n  afterTransactions: Transaction[] = [],\r\n  setupState?: SetupState,\r\n): Promise<MintResult | null> => {\r\n  const mint = setupState?.mint ?? anchor.web3.Keypair.generate();\r\n  const userTokenAccountAddress = (\r\n    await getAtaForMint(mint.publicKey, payer)\r\n  )[0];\r\n\r\n  const userPayingAccountAddress = candyMachine.state.tokenMint\r\n    ? (await getAtaForMint(candyMachine.state.tokenMint, payer))[0]\r\n    : payer;\r\n\r\n  const candyMachineAddress = candyMachine.id;\r\n  const remainingAccounts = [];\r\n  const cleanupInstructions = [];\r\n  const instructions = [];\r\n  const signers: anchor.web3.Keypair[] = [];\r\n  console.log('SetupState: ', setupState);\r\n  if (!setupState) {\r\n    signers.push(mint);\r\n    instructions.push(\r\n      ...[\r\n        anchor.web3.SystemProgram.createAccount({\r\n          fromPubkey: payer,\r\n          newAccountPubkey: mint.publicKey,\r\n          space: MintLayout.span,\r\n          lamports:\r\n            await candyMachine.program.provider.connection.getMinimumBalanceForRentExemption(\r\n              MintLayout.span,\r\n            ),\r\n          programId: TOKEN_PROGRAM_ID,\r\n        }),\r\n        Token.createInitMintInstruction(\r\n          TOKEN_PROGRAM_ID,\r\n          mint.publicKey,\r\n          0,\r\n          payer,\r\n          payer,\r\n        ),\r\n        createAssociatedTokenAccountInstruction(\r\n          userTokenAccountAddress,\r\n          payer,\r\n          payer,\r\n          mint.publicKey,\r\n        ),\r\n        Token.createMintToInstruction(\r\n          TOKEN_PROGRAM_ID,\r\n          mint.publicKey,\r\n          userTokenAccountAddress,\r\n          payer,\r\n          [],\r\n          1,\r\n        ),\r\n      ],\r\n    );\r\n  }\r\n\r\n  if (candyMachine.state.gatekeeper) {\r\n    remainingAccounts.push({\r\n      pubkey: (\r\n        await getNetworkToken(\r\n          payer,\r\n          candyMachine.state.gatekeeper.gatekeeperNetwork,\r\n        )\r\n      )[0],\r\n      isWritable: true,\r\n      isSigner: false,\r\n    });\r\n\r\n    if (candyMachine.state.gatekeeper.expireOnUse) {\r\n      remainingAccounts.push({\r\n        pubkey: CIVIC,\r\n        isWritable: false,\r\n        isSigner: false,\r\n      });\r\n      remainingAccounts.push({\r\n        pubkey: (\r\n          await getNetworkExpire(\r\n            candyMachine.state.gatekeeper.gatekeeperNetwork,\r\n          )\r\n        )[0],\r\n        isWritable: false,\r\n        isSigner: false,\r\n      });\r\n    }\r\n  }\r\n  if (candyMachine.state.whitelistMintSettings) {\r\n    const mint = new anchor.web3.PublicKey(\r\n      candyMachine.state.whitelistMintSettings.mint,\r\n    );\r\n\r\n    const whitelistToken = (await getAtaForMint(mint, payer))[0];\r\n    remainingAccounts.push({\r\n      pubkey: whitelistToken,\r\n      isWritable: true,\r\n      isSigner: false,\r\n    });\r\n\r\n    if (candyMachine.state.whitelistMintSettings.mode.burnEveryTime) {\r\n      const whitelistBurnAuthority = anchor.web3.Keypair.generate();\r\n\r\n      remainingAccounts.push({\r\n        pubkey: mint,\r\n        isWritable: true,\r\n        isSigner: false,\r\n      });\r\n      remainingAccounts.push({\r\n        pubkey: whitelistBurnAuthority.publicKey,\r\n        isWritable: false,\r\n        isSigner: true,\r\n      });\r\n      signers.push(whitelistBurnAuthority);\r\n      const exists =\r\n        await candyMachine.program.provider.connection.getAccountInfo(\r\n          whitelistToken,\r\n        );\r\n      if (exists) {\r\n        instructions.push(\r\n          Token.createApproveInstruction(\r\n            TOKEN_PROGRAM_ID,\r\n            whitelistToken,\r\n            whitelistBurnAuthority.publicKey,\r\n            payer,\r\n            [],\r\n            1,\r\n          ),\r\n        );\r\n        cleanupInstructions.push(\r\n          Token.createRevokeInstruction(\r\n            TOKEN_PROGRAM_ID,\r\n            whitelistToken,\r\n            payer,\r\n            [],\r\n          ),\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  if (candyMachine.state.tokenMint) {\r\n    const transferAuthority = anchor.web3.Keypair.generate();\r\n\r\n    signers.push(transferAuthority);\r\n    remainingAccounts.push({\r\n      pubkey: userPayingAccountAddress,\r\n      isWritable: true,\r\n      isSigner: false,\r\n    });\r\n    remainingAccounts.push({\r\n      pubkey: transferAuthority.publicKey,\r\n      isWritable: false,\r\n      isSigner: true,\r\n    });\r\n\r\n    instructions.push(\r\n      Token.createApproveInstruction(\r\n        TOKEN_PROGRAM_ID,\r\n        userPayingAccountAddress,\r\n        transferAuthority.publicKey,\r\n        payer,\r\n        [],\r\n        candyMachine.state.price.toNumber(),\r\n      ),\r\n    );\r\n    cleanupInstructions.push(\r\n      Token.createRevokeInstruction(\r\n        TOKEN_PROGRAM_ID,\r\n        userPayingAccountAddress,\r\n        payer,\r\n        [],\r\n      ),\r\n    );\r\n  }\r\n  const metadataAddress = await getMetadata(mint.publicKey);\r\n  const masterEdition = await getMasterEdition(mint.publicKey);\r\n\r\n  const [candyMachineCreator, creatorBump] = await getCandyMachineCreator(\r\n    candyMachineAddress,\r\n  );\r\n\r\n  console.log(remainingAccounts.map(rm => rm.pubkey.toBase58()));\r\n  instructions.push(\r\n    await candyMachine.program.instruction.mintNft(creatorBump, {\r\n      accounts: {\r\n        candyMachine: candyMachineAddress,\r\n        candyMachineCreator,\r\n        payer: payer,\r\n        wallet: candyMachine.state.treasury,\r\n        mint: mint.publicKey,\r\n        metadata: metadataAddress,\r\n        masterEdition,\r\n        mintAuthority: payer,\r\n        updateAuthority: payer,\r\n        tokenMetadataProgram: TOKEN_METADATA_PROGRAM_ID,\r\n        tokenProgram: TOKEN_PROGRAM_ID,\r\n        systemProgram: SystemProgram.programId,\r\n        rent: anchor.web3.SYSVAR_RENT_PUBKEY,\r\n        clock: anchor.web3.SYSVAR_CLOCK_PUBKEY,\r\n        recentBlockhashes: SYSVAR_SLOT_HASHES_PUBKEY,\r\n        instructionSysvarAccount: anchor.web3.SYSVAR_INSTRUCTIONS_PUBKEY,\r\n      },\r\n      remainingAccounts:\r\n        remainingAccounts.length > 0 ? remainingAccounts : undefined,\r\n    }),\r\n  );\r\n\r\n  const [collectionPDA] = await getCollectionPDA(candyMachineAddress);\r\n  const collectionPDAAccount =\r\n    await candyMachine.program.provider.connection.getAccountInfo(\r\n      collectionPDA,\r\n    );\r\n\r\n  if (collectionPDAAccount && candyMachine.state.retainAuthority) {\r\n    try {\r\n      const collectionData =\r\n        (await candyMachine.program.account.collectionPda.fetch(\r\n          collectionPDA,\r\n        )) as CollectionData;\r\n      console.log(collectionData);\r\n      const collectionMint = collectionData.mint;\r\n      const collectionAuthorityRecord = await getCollectionAuthorityRecordPDA(\r\n        collectionMint,\r\n        collectionPDA,\r\n      );\r\n      console.log(collectionMint);\r\n      if (collectionMint) {\r\n        const collectionMetadata = await getMetadata(collectionMint);\r\n        const collectionMasterEdition = await getMasterEdition(collectionMint);\r\n        console.log('Collection PDA: ', collectionPDA.toBase58());\r\n        console.log('Authority: ', candyMachine.state.authority.toBase58());\r\n        instructions.push(\r\n          await candyMachine.program.instruction.setCollectionDuringMint({\r\n            accounts: {\r\n              candyMachine: candyMachineAddress,\r\n              metadata: metadataAddress,\r\n              payer: payer,\r\n              collectionPda: collectionPDA,\r\n              tokenMetadataProgram: TOKEN_METADATA_PROGRAM_ID,\r\n              instructions: anchor.web3.SYSVAR_INSTRUCTIONS_PUBKEY,\r\n              collectionMint,\r\n              collectionMetadata,\r\n              collectionMasterEdition,\r\n              authority: candyMachine.state.authority,\r\n              collectionAuthorityRecord,\r\n            },\r\n          }),\r\n        );\r\n      }\r\n    } catch (error) {\r\n      console.error(error);\r\n    }\r\n  }\r\n\r\n  const instructionsMatrix = [instructions, cleanupInstructions];\r\n  const signersMatrix = [signers, []];\r\n\r\n  try {\r\n    const txns = (\r\n      await sendTransactions(\r\n        candyMachine.program.provider.connection,\r\n        candyMachine.program.provider.wallet,\r\n        instructionsMatrix,\r\n        signersMatrix,\r\n        SequenceType.StopOnFailure,\r\n        'singleGossip',\r\n        () => {},\r\n        () => false,\r\n        undefined,\r\n        beforeTransactions,\r\n        afterTransactions,\r\n      )\r\n    ).txs.map(t => t.txid);\r\n    const mintTxn = txns[0];\r\n    return {\r\n      mintTxId: mintTxn,\r\n      metadataKey: metadataAddress,\r\n    };\r\n  } catch (e) {\r\n    console.log(e);\r\n  }\r\n  return null;\r\n};\r\n\r\nexport const shortenAddress = (address: string, chars = 4): string => {\r\n  return `${address.slice(0, chars)}...${address.slice(-chars)}`;\r\n};\r\n\r\nconst sleep = (ms: number): Promise<void> => {\r\n  return new Promise(resolve => setTimeout(resolve, ms));\r\n};\r\n"]},"metadata":{},"sourceType":"module"}